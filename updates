#!/usr/bin/env bash

# ─────────────────────────────────────────────
#   DWMBlocks Update Checker — Arch + yay
# ─────────────────────────────────────────────

# Check if a command exists
_checkCommandExists() {
    command -v "$1" >/dev/null 2>&1
}

# Prevent multiple concurrent runs
script_name=$(basename "$0")
instance_count=$(ps aux | grep -F "$script_name" | grep -v grep | grep -v $$ | wc -l)
[ $instance_count -gt 1 ] && sleep $instance_count

cache_file="/tmp/updates_count"

# Function to count updates
get_updates() {
    if _checkCommandExists pacman; then
        while [ -f /var/lib/pacman/db.lck ]; do sleep 1; done
        if _checkCommandExists yay; then
            updates_aur=$(yay -Qum 2>/dev/null | wc -l)
            updates_pacman=$(checkupdates 2>/dev/null | wc -l)
            echo $((updates_aur + updates_pacman))
        else
            checkupdates 2>/dev/null | wc -l
        fi
    fi
}

# Normal execution: show number of updates
updates=$(get_updates)
echo "$updates" > "$cache_file"

if [ "$updates" -eq 0 ]; then
    echo " 0"
else
    echo " $updates"
fi

